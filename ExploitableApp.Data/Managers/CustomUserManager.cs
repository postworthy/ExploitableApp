using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;
using ExploitableApp.Data.Models;
using Microsoft.AspNetCore.Identity;
using System.IO;
using ExploitableApp.Data.Services;
using ExploitableApp.Data.DataAccess;
using Microsoft.Extensions.Configuration;
using System.Net;

namespace ExploitableApp.Data.Managers
{
    public class CustomUserManager
    {
        public IConfiguration Configuration
        {
            get;
            private set;
        }

        public CustomUserManager(IConfiguration configuration)
        {
            Configuration = configuration;
        }

        private ApplicationDbContext GetContext()
        {
            //Configuration.GetConnectionString("DefaultConnection").Replace("Server=db", $"Server={Environment.GetEnvironmentVariable("DB_SERVER") ?? "db"}")
            var options = new DbContextOptionsBuilder<ApplicationDbContext>();

            if (Environment.GetEnvironmentVariable("USEMYSQL")?.ToLower() == "true")
                options.UseMySql(Configuration.GetConnectionString("DefaultMySqlConnection").Replace("Server=db", $"Server={Environment.GetEnvironmentVariable("DB_SERVER") ?? "db"}"), x => x.ServerVersion(new Version(5, 5, 0), Pomelo.EntityFrameworkCore.MySql.Infrastructure.ServerType.MySql));
            else if (Environment.GetEnvironmentVariable("USEPOSTGRES")?.ToLower() == "true")
                options.UseNpgsql(Configuration.GetConnectionString("DefaultPostgresConnection").Replace("Host=db", $"Host={Environment.GetEnvironmentVariable("DB_SERVER") ?? "db"}"), x => x.SetPostgresVersion(new Version(9, 6, 14)));
            else
                options.UseSqlServer(Configuration.GetConnectionString("DefaultConnection").Replace("Server=db", $"Server={Environment.GetEnvironmentVariable("DB_SERVER") ?? "db"}"));

            return new ApplicationDbContext(options.Options);
        }

        public IEnumerable<string> GetEmailsLike(string email)
        {
            using (var context = GetContext())
            using (var connection = context.Database.GetDbConnection())
            {
                connection.Open();
                var cmd = connection.CreateCommand();
                cmd.CommandText = $"select email from AspNetUsers where email like '{email.Replace("'","''").Replace("*","%")}'";
                using (var reader = cmd.ExecuteReader())
                {
                    if (!reader.HasRows)
                        yield break;

                    while (reader.Read())
                    {
                        yield return reader["email"].ToString();
                    }
                }
            }
        }
    }
}
