using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;
using ExploitableApp.Data.Models;
using Microsoft.AspNetCore.Identity;
using System.IO;
using ExploitableApp.Data.Services;
using ExploitableApp.Data.DataAccess;
using Microsoft.Extensions.Configuration;
using System.Net;

namespace ExploitableApp.Data.Managers
{
    public class BankingAccountManager
    {
        public IConfiguration Configuration
        {
            get;
            private set;
        }
        public BankingAccountManager(IConfiguration configuration)
        {
            Configuration = configuration;
        }

        private ApplicationDbContext GetContext()
        {
            //Configuration.GetConnectionString("DefaultConnection").Replace("Server=db", $"Server={Environment.GetEnvironmentVariable("DB_SERVER") ?? "db"}")
            var options = new DbContextOptionsBuilder<ApplicationDbContext>();

            if (Environment.GetEnvironmentVariable("USEMYSQL")?.ToLower() == "true")
                options.UseMySql(Configuration.GetConnectionString("DefaultMySqlConnection").Replace("Server=db", $"Server={Environment.GetEnvironmentVariable("DB_SERVER") ?? "db"}"), x => x.ServerVersion(new Version(5, 5, 0), Pomelo.EntityFrameworkCore.MySql.Infrastructure.ServerType.MySql));
            else if (Environment.GetEnvironmentVariable("USEPOSTGRES")?.ToLower() == "true")
                options.UseNpgsql(Configuration.GetConnectionString("DefaultPostgresConnection").Replace("Host=db", $"Host={Environment.GetEnvironmentVariable("DB_SERVER") ?? "db"}"), x => x.SetPostgresVersion(new Version(9, 6, 14)));
            else
                options.UseSqlServer(Configuration.GetConnectionString("DefaultConnection").Replace("Server=db", $"Server={Environment.GetEnvironmentVariable("DB_SERVER") ?? "db"}"));

            return new ApplicationDbContext(options.Options);
        }

        public BankingAccount CreateAccount(ApplicationUser user, float startingBalance = 0)
        {
            using (var context = GetContext())
            {
                var owner = context.Users.Find(user.Id);
                if (owner.Id != user.Id) throw new Exception("User Not Found while Creating Account!");
                var account = new BankingAccount
                {
                    AccountOwner = owner,
                    Balance = startingBalance
                };
                context.BankingAccounts.Add(account);
                context.SaveChanges();
                return account;
            }
        }

        public List<BankingAccount> GetAccounts(ApplicationUser user)
        {
            using (var context = GetContext())
            {
                return context.BankingAccounts
                              .Where(x => x.AccountOwner.Id == user.Id)
                              .AsNoTracking()
                              .ToList();
            }
        }

        public IQueryable<Transaction> GetTransactions(BankingAccount account)
        {
            var context = GetContext();
            return context.Transactions
                          .Where(x => x.To.ID == account.ID || x.From.ID == account.ID)
                          .AsNoTracking();
        }

        public Transaction GetTransaction(string transactionID)
        {
            using (var context = GetContext())
            {
                return context.Transactions
                              .Include("To")
                              .Include("From")
                              .Where(x => x.ID == transactionID)
                              .AsNoTracking()
                              .FirstOrDefault();
            }
        }

        public List<Transaction> GetAccountTransactions(BankingAccount account, int skip = 0, int take = 25)
        {
            using (var context = GetContext())
            {
                return context.Transactions
                              .Where(x => x.To.ID == account.ID || x.From.ID == account.ID)
                              .Skip(skip)
                              .Take(take)
                              .AsNoTracking()
                              .ToList();
            }
        }

        public async Task<long> CountTransactions(string status = null)
        {
            using (var context = GetContext())
            {
                return await context.Transactions
                              .Where(x => status == null || x.Status.ToLower() == status.ToLower())
                              .LongCountAsync();
            }
        }

        public Transaction CreateTransaction(BankingAccount fromAccount, BankingAccount toAccount, float amount, string description, DateTime time, bool bypassProcessing = false)
        {
            using (var context = GetContext())
            {
                var from = context.BankingAccounts.Find(fromAccount.ID);
                var to = context.BankingAccounts.Find(toAccount.ID);
                if (from.ID != fromAccount.ID || to.ID != toAccount.ID) throw new Exception("User Not Found while Creating Transaction!");
                var t = new Transaction
                {
                    Amount = amount,
                    Description = description,
                    From = from,
                    To = to,
                    Status = "Pending",
                    Time = time
                };
                context.Transactions.Add(t);
                context.SaveChanges();
                if (!bypassProcessing)
                {
                    using (var wc = new WebClient())
                    {
                        wc.DownloadString($"{Environment.GetEnvironmentVariable("WEBSERVICE_ENDPOINT") ?? "http://exploitableapp-ws:8080"}/api/processtransaction/{t.ID}");
                    }
                }
                return t;
            }
        }

        public Transaction CompleteTransaction(Transaction transaction)
        {
            using (var context = GetContext())
            using (var scope = context.Database.BeginTransaction())
            {
                try
                {
                    var t = context.Transactions.Find(transaction.ID);
                    var from = context.BankingAccounts.Find(transaction.From.ID);
                    var to = context.BankingAccounts.Find(transaction.To.ID);
                    if (t.ID != transaction.ID || from.ID != transaction.From.ID || to.ID != transaction.To.ID) throw new Exception("Value Not Found while Creating Transaction!");
                    t.Status = "Completed";
                    from.Balance -= t.Amount;
                    to.Balance += t.Amount;
                    context.SaveChanges();
                    scope.Commit();
                    return t;
                }
                catch
                {
                    scope.Rollback();
                    throw;
                }
            }
        }
    }
}
